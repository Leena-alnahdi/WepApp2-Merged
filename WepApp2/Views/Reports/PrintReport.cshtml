@using System.Reflection
@{
    Layout = null;
    var selectedFields = ViewBag.SelectedFields as List<string> ?? new List<string>();
    var reportType = ViewBag.ReportType as string ?? "";
    var serviceType = ViewBag.ServiceType as string ?? "";

    // دالة للحصول على قيمة خاصية من كائن ديناميكي
    Func<dynamic, string, object> GetPropertyValue = (obj, propName) =>
    {
        try
        {
            // استبدال المسافات بشرطة سفلية للوصول للخصائص
            var prop = propName.Replace(" ", "_");
            Type type = obj.GetType();
            PropertyInfo propInfo = type.GetProperty(prop);
            if (propInfo != null)
                return propInfo.GetValue(obj, null);
            return "غير محدد";
        }
        catch
        {
            return "غير محدد";
        }
    };

    // تحديد الحقول المراد عرضها حسب نوع التقرير
    List<string> displayFields = new List<string>();

    if (reportType == "تقرير الطلبات")
    {
        displayFields = new List<string> { "المستفيد", "نوع الخدمة", "الجهاز", "التاريخ", "الوقت", "المشرف المسند", "الحالة" };
    }
    else if (reportType == "تقرير الأجهزة")
    {
        displayFields = new List<string> { "اسم الجهاز", "النوع", "الموقع", "الشركة", "الطراز", "تاريخ آخر صيانة", "الحالة" };
    }
    else if (reportType == "تقرير المستخدمين")
    {
        displayFields = new List<string> { "الاسم", "اسم المستخدم", "نوع المستخدم", "الجهة", "القسم", "البريد الإلكتروني", "رقم الجوال" };
    }
    else if (reportType == "تقرير الخدمات")
    {
        // تحديد الحقول حسب نوع الخدمة
        if (serviceType == "الدورات التدريبية")
        {
            displayFields = new List<string> { "نوع الخدمة", "اسم الدورة", "مجال الدورة", "مقدم الدورة", "المقاعد", "الوقت", "الحالة" };
        }
        else if (serviceType == "إعارة الأجهزة")
        {
            displayFields = new List<string> { "نوع الخدمة", "اسم الجهاز", "المدة", "مقدم الطلب", "حالة الطلب", "تاريخ الطلب" };
        }
        else if (serviceType == "حجز الأجهزة")
        {
            displayFields = new List<string> { "اسم الجهاز", "اسم الشخص", "تاريخ الحجز", "الوقت", "الحالة" };
        }
        else
        {
            displayFields = new List<string> { "نوع الخدمة", "وصف الخدمة", "تاريخ الطلب", "المستخدم", "الحالة" };
        }
    }

    // فلترة الحقول المطلوبة فقط
    var fieldsToDisplay = selectedFields.Count > 0
        ? displayFields.Where(f => selectedFields.Contains(f)).ToList()
        : displayFields;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>@ViewBag.ReportTitle</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            margin: 40px;
            color: #333;
            direction: rtl;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .report-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .report-subtitle {
            font-size: 20px;
            color: #34495e;
            margin-bottom: 10px;
        }

        .service-type {
            font-size: 16px;
            color: #3498db;
            margin-bottom: 5px;
        }

        .report-meta {
            text-align: center;
            font-size: 14px;
            margin-bottom: 20px;
            color: #7f8c8d;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            direction: rtl;
            margin-top: 20px;
        }

            .report-table th,
            .report-table td {
                border: 1px solid #ccc;
                padding: 8px;
                text-align: center;
            }

            .report-table th {
                background-color: @(reportType == "تقرير الأجهزة" ? "#e8f5e9" : reportType == "تقرير المستخدمين" ? "#e3f2fd" : reportType == "تقرير الخدمات" ? "#fff3cd" : "#eaf5ea");
                font-weight: bold;
                color: #2c3e50;
            }

            .report-table tbody tr:nth-child(even) {
                background-color: #f9f9f9;
            }

            .report-table tbody tr:hover {
                background-color: #f0f0f0;
            }

        .status-badge {
            padding: 4px 10px;
            border-radius: 6px;
            color: white;
            font-size: 13px;
            display: inline-block;
            font-weight: 500;
        }

        .status-new {
            background-color: #3498db;
        }

        .status-assigned {
            background-color: #f39c12;
        }

        .status-approved {
            background-color: #27ae60;
        }

        .status-rejected {
            background-color: #e74c3c;
        }

        .status-completed {
            background-color: #95a5a6;
        }

        .status-active {
            background-color: #27ae60;
        }

        .status-maintenance {
            background-color: #f39c12;
        }

        .status-inactive {
            background-color: #e74c3c;
        }

        .user-type-badge {
            padding: 4px 10px;
            border-radius: 6px;
            color: white;
            font-size: 13px;
            display: inline-block;
            font-weight: 500;
        }

        .type-admin {
            background-color: #e74c3c;
        }

        .type-faculty {
            background-color: #3498db;
        }

        .type-student {
            background-color: #27ae60;
        }

        .email-link {
            color: #3498db;
            text-decoration: none;
        }

            .email-link:hover {
                text-decoration: underline;
            }

        .phone-number {
            direction: ltr;
            text-align: center;
            font-family: Arial, sans-serif;
        }

        .report-footer {
            margin-top: 30px;
            font-size: 12px;
            text-align: center;
            color: gray;
        }

        .print-button {
            display: block;
            margin: 30px auto 10px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .print-button:hover {
                background-color: #146c43;
                transform: scale(1.05);
            }

        @@media print {
            .print-button {
                display: none;
            }

            body {
                margin: 20px;
            }

            .email-link {
                color: black !important;
                text-decoration: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="report-header">
        <h1 class="report-title">@ViewBag.ReportTitle</h1>
        <h2 class="report-subtitle">@ViewBag.ReportType</h2>
        @if (!string.IsNullOrEmpty(serviceType) && reportType == "تقرير الخدمات")
        {
            <div class="service-type">نوع الخدمة: @serviceType</div>
        }
        <div class="report-meta">
            @if (ViewBag.FromDate != null && ViewBag.ToDate != null)
            {
                <span>التقرير من تاريخ @ViewBag.FromDate إلى @ViewBag.ToDate</span>
            }
        </div>
    </div>

    @if (Model != null && ((IEnumerable<dynamic>)Model).Count() > 0)
    {
        <table class="report-table">
            <thead>
                <tr>
                    @foreach (var field in fieldsToDisplay)
                    {
                        <th>@field</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        @foreach (var field in fieldsToDisplay)
                        {
                            <td>
                                @{
                                    var value = GetPropertyValue(item, field);
                                    string displayValue = value?.ToString() ?? "غير محدد";

                                    // معالجة خاصة لبعض الحقول
                                    if (field == "الحالة" || field == "حالة الطلب")
                                    {
                                        string statusClass = "";
                                        switch (displayValue)
                                        {
                                            case "جديد":
                                                statusClass = "status-new";
                                                break;
                                            case "مسند":
                                                statusClass = "status-assigned";
                                                break;
                                            case "موافق عليه":
                                            case "موافق من المشرف":
                                                statusClass = "status-approved";
                                                break;
                                            case "مرفوض من المشرف":
                                                statusClass = "status-rejected";
                                                break;
                                            case "مرفوض":
                                                statusClass = "status-rejected";
                                                break;
                                            case "منتهي":
                                                statusClass = "status-completed";
                                                break;
                                            case "نشط":
                                            case "تشغيل":
                                                statusClass = "status-active";
                                                break;
                                            case "تحت الصيانة":
                                            case "صيانة":
                                                statusClass = "status-maintenance";
                                                break;
                                            case "غير عاملة":
                                            case "خارج الخدمة":
                                                statusClass = "status-inactive";
                                                break;
                                        }
                                        <span class="status-badge @statusClass">@displayValue</span>
                                    }
                                    // else if (field == "نوع المستخدم")
                                    // {
                                    //     string typeClass = "";
                                    //     switch (displayValue)
                                    //     {
                                    //         case "مشرف":
                                    //             typeClass = "type-admin";
                                    //             break;
                                    //         case "عضو هيئة تدريس":
                                    //             typeClass = "type-faculty";
                                    //             break;
                                    //         case "طالب":
                                    //             typeClass = "type-student";
                                    //             break;
                                    //         default :
                                    //             typeClass = "type-student";
                                    //             break;
                                    //     }
                                    // <span class="user-type-badge @typeClass">@displayValue</span>
                                    // }
                                    else if (field == "البريد الإلكتروني" && displayValue != "غير محدد")
                                    {
                                        <a href="mailto:@displayValue" class="email-link">@displayValue</a>
                                    }
                                    else if (field == "رقم الجوال")
                                    {
                                        <span class="phone-number">@displayValue</span>
                                    }
                                    else
                                    {
                                        @displayValue
                                    }
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    }
    else
    {
        <p style="text-align: center; margin-top: 50px; font-size: 18px; color: #7f8c8d;">
            لا توجد بيانات للعرض في هذا التقرير
        </p>
    }

    <div class="report-footer">
        <p>تم إنشاء هذا التقرير بواسطة نظام تقارير معمل الابتكارات - @DateTime.Now.ToString("yyyy-MM-dd HH:mm")</p>
    </div>

    <button class="print-button" onclick="window.print()">طباعة التقرير</button>
</body>
</html>